// State variables
let isFuncionarioLogado = false;
let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
let total = 0;

// Elements
const clienteSection = document.getElementById('clienteSection');
const funcionarioSection = document.getElementById('funcionarioSection');
const toggleBtn = document.getElementById('toggleViewBtn');
const loginModal = document.getElementById('loginModal');
const loginError = document.getElementById('loginError');
const finalizarPedidoBtn = document.getElementById('finalizarPedidoBtn');
const pedidosFuncionario = document.getElementById('pedidos-funcionario');

// Function to show client view
function mostrarCliente() {
  clienteSection.classList.add('active');
  funcionarioSection.classList.remove('active');
  toggleBtn.innerText = 'Área do Funcionário';
  toggleBtn.setAttribute('aria-label', 'Alternar para área do funcionário');
}

// Function to show employee view (only if logged in)
function mostrarFuncionario() {
  if (!isFuncionarioLogado) {
    // Show login modal
    loginModal.classList.remove('hidden');
    // Autofocus username input
    document.getElementById('usernameInput').focus();
    return;
  }
  clienteSection.classList.remove('active');
  funcionarioSection.classList.add('active');
  toggleBtn.innerText = 'Área do Cliente';
  toggleBtn.setAttribute('aria-label', 'Alternar para área do cliente');
}

// Toggle handler
toggleBtn.addEventListener('click', () => {
  if (clienteSection.classList.contains('active')) {
    mostrarFuncionario();
  } else {
    mostrarCliente();
  }
});

// Login function
function realizarLogin(event) {
  event.preventDefault();
  const username = document.getElementById('usernameInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  if (username === 'funcionario' && password === '1234') {
    isFuncionarioLogado = true;
    loginModal.classList.add('hidden');
    loginError.innerText = '';
    // Clear login form fields
    document.getElementById('loginForm').reset();
    mostrarFuncionario();
  } else {
    loginError.innerText = 'Usuário ou senha incorretos.';
  }
}

// Close modal on outside click or Escape key
loginModal.addEventListener('click', (e) => {
  if (e.target === loginModal) {
    loginModal.classList.add('hidden');
    loginError.innerText = '';
  }
});

document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && !loginModal.classList.contains('hidden')) {
    loginModal.classList.add('hidden');
    loginError.innerText = '';
  }
});

// Client-side cart functions
function adicionarAoCarrinho(produto, preco) {
  const item = carrinho.find(i => i.nome === produto);
  if (item) {
    item.quantidade++;
  } else {
    carrinho.push({ nome: produto, preco: preco, quantidade: 1 });
  }
  atualizarCarrinho();
}

function atualizarCarrinho() {
  const carrinhoLista = document.getElementById('carrinho-lista');
  carrinhoLista.innerHTML = '';
  total = 0;
  carrinho.forEach(item => {
    total += item.preco * item.quantidade;
    const itemDiv = document.createElement('div');
    itemDiv.className = 'carrinho-item';
    itemDiv.innerHTML = `
      ${item.nome} (x${item.quantidade}) - R$ ${item.preco.toFixed(2)}
      <button class=" botao botao-remover" aria-label="Remover um ${item.nome} do carrinho" onclick="removerDoCarrinho('${item.nome}')">Remover</button>
    `;
    carrinhoLista.appendChild(itemDiv);
  });
  document.getElementById('carrinho-total').innerText = `Total: R$ ${total.toFixed(2)}`;

  // Enable finalizarPedidoBtn only if there are items
  finalizarPedidoBtn.disabled = carrinho.length === 0;

  // Update localStorage
  localStorage.setItem('carrinho', JSON.stringify(carrinho));
}

function removerDoCarrinho(nome) {
  const itemIndex = carrinho.findIndex(i => i.nome === nome);
  if (itemIndex > -1) {
    carrinho[itemIndex].quantidade--;
    if (carrinho[itemIndex].quantidade === 0) {
      carrinho.splice(itemIndex, 1);
    }
  }
  atualizarCarrinho();
}

// Orders stored in memory as array of objects
const listaPedidos = JSON.parse(localStorage.getItem('listaPedidos')) || [];

function finalizarPedido() {
  if (carrinho.length === 0) return;
  const pedidoId = Date.now();
  // Clone the current cart as a new pedido
  const pedido = {
    id: pedidoId,
    itens: JSON.parse(JSON.stringify(carrinho)),
    total: total,
    finalizadoItens: new Set(), // IDs or names of completed items
  };
  listaPedidos.push(pedido);
  localStorage.setItem('listaPedidos', JSON.stringify(listaPedidos));
  atualizarPedidosFuncionario();
  // Reset cart
  carrinho = [];
  atualizarCarrinho();
  alert('Pedido finalizado com sucesso!');
}

function atualizarPedidosFuncionario() {
  pedidosFuncionario.innerHTML = '';
  if (listaPedidos.length === 0) {
    pedidosFuncionario.innerHTML = '<p>Nenhum pedido no momento.</p>';
    return;
  }

  listaPedidos.forEach(pedido => {
    const pedidoDiv = document.createElement('div');
    pedidoDiv.className = 'funcionario-pedido';
    pedidoDiv.setAttribute('data-pedido-id', pedido.id);

    // Container for pedido items
    let itensHtml = '';
    pedido.itens.forEach(item => {
      const itemKey = item.nome;
      const finalizado = pedido.finalizadoItens.has(itemKey);
      itensHtml += `
        <div class="pedido-item" aria-live="polite">
          <span>${item.nome} - Quantidade: ${item.quantidade}</span>
          <button class="pedido-btn" aria-pressed="${finalizado}" aria-label="Marcar ${item.nome} como ${finalizado ? 'não finalizado' : 'finalizado'}"
            onclick="toggleFinalizado('${pedido.id}', '${item.nome}')">
            ${finalizado ? 'Desfazer' : 'Finalizado'}
          </button>
        </div>
      `;
    });

    pedidoDiv.innerHTML = `
      <div class="pedido-info"><strong>Pedido #${pedido.id}</strong> - Total: R$ ${pedido.total.toFixed(2)}</div>
      <div class="pedido-lista">${itensHtml}</div>
      <button class="botao" onclick="finalizarPedidoFuncionario('${pedido.id}')">Finalizar Pedido</button>
    `;
    pedidosFuncionario.appendChild(pedidoDiv);
  });
}

function toggleFinalizado(id, itemNome) {
  const pedido = listaPedidos.find(p => p.id.toString() === id.toString());
  if (!pedido) return;
  if (pedido.finalizadoItens.has(itemNome)) {
    pedido.finalizadoItens.delete(itemNome);
  } else {
    pedido.finalizadoItens.add(itemNome);
  }
  atualizarPedidosFuncionario();
}

function finalizarPedidoFuncionario(id) {
  const idx = listaPedidos.findIndex(p => p.id.toString() === id.toString());
  if (idx === -1) return;
  listaPedidos.splice(idx, 1);
  localStorage.setItem('listaPedidos', JSON.stringify(listaPedidos));
  atualizarPedidosFuncionario();
  alert('Pedido finalizado e removido.');
}

// Initialize views on load
document.addEventListener('DOMContentLoaded', () => {
  mostrarCliente();
  atualizarCarrinho();
  atualizarPedidosFuncionario();
});
